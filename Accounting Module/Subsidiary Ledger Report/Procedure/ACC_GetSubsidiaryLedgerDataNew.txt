USE [KH_HMSERP]
GO
/****** Object:  StoredProcedure [dbo].[ACC_GetSubsidiaryLedgerDataNew]    Script Date: 10/6/2025 8:44:29 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ACC_GetSubsidiaryLedgerDataNew 'ACC_AccountKH', 'ACC_VoucherKH', '67', '09/29/2024', '09/29/2024'



ALTER PROCEDURE [dbo].[ACC_GetSubsidiaryLedgerDataNew]

@AccTable NVARCHAR(20),
@VoucherTable NVARCHAR(20),
@AccountID NVARCHAR(20),
@FromDate NVARCHAR(20),
@ToDate NVARCHAR(20)

AS


SELECT

DISTINCT

V.VoucherDate,
V.VoucherNumber,
V.AccountID,
--[dbo].[ACC_GetOppositeAccountName](@AccountID, V.VoucherNumber) AS AccountName,
ISNULL(STUFF((
          SELECT  ',' + CONVERT(NVARCHAR(500), A2.AccountName)
          FROM ACC_VoucherKH v2
		  INNER JOIN  ACC_AccountKH a2 ON v2.AccountID = a2.AccountID
          WHERE  v2.VoucherNumber = V.VoucherNumber 
		  ORDER BY A2.AccountName
          FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 1, '') + ' Acc/=' + (SELECT CONVERT(NVARCHAR(5), COUNT(account.AccountID))
		  FROM ACC_VoucherKH voucher
		  INNER JOIN ACC_AccountKH account ON voucher.AccountID = account.AccountID
          WHERE voucher.VoucherNumber = V.VoucherNumber),
		  		  
		  'NOT ASSIGNED YET') AS AccountName,

A.AccountCode,
V.RefNo + Char(10) + V.Description AS Description,
V.BankAccountName,
CASE WHEN V.ChequeNo = '-' THEN NULL
ELSE V.ChequeDate END AS ChequeDate,
V.ChequeNo,

ISNULL(V.DebitAmount,0) AS DebitAmount,
ISNULL(V.CreditAmount,0) AS CreditAmount,
0.00 AS Balance,
'''' AS BalanceType

FROM ACC_VoucherKH  V
INNER JOIN ACC_AccountKH  A ON A.AccountID = V.AccountID 

 WHERE V.Status = 'A' AND CONVERT(DATE, V.VoucherDate) BETWEEN CONVERT(DATE, @FromDate) AND CONVERT(DATE,@ToDate) AND V.AccountID = @AccountID
 order by V.VoucherDate
 
